<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>D íaniQ RefStat ‚Äì Fotboll</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  .fade { opacity: 0.4; }
</style>
</head>

<body class="bg-gray-100 p-6">

<h1 class="text-3xl font-bold mb-6">D íaniQ RefStat ‚Äì Fotboll</h1>

<!-- LOADING BAR -->
<div id="loadingBar" class="hidden mb-4">
  <div class="w-full bg-gray-300 rounded h-4">
    <div id="loadingProgress" class="bg-blue-500 h-4 rounded w-0 transition-all"></div>
  </div>
  <p id="loadingText" class="text-sm text-gray-600 mt-1">F√∂rbereder‚Ä¶</p>
</div>

<!-- FILTER CARD -->
<div class="bg-white shadow p-4 rounded mb-6">
  <div class="flex items-center gap-4 flex-wrap">

    <!-- DISTRICT -->
    <div>
      <label class="block text-sm font-semibold">Distrikt:</label>
      <select id="districtSelect" class="border rounded px-2 py-1 w-48">
        <option value="7">G√∂teborg</option>
        <option value="1">Nationellt</option>
        <option value="2">Blekinge</option>
        <option value="28">Bohusl√§n-Dalsland</option>
        <option value="4">Dalarna</option>
        <option value="6">Gestrikland</option>
        <option value="5">Gotland</option>
        <option value="8">Halland</option>
        <option value="9">H√§lsingland</option>
        <option value="10">J√§mtland-H√§rjedalen</option>
        <option value="11">Medelpad</option>
        <option value="12">Norrbotten</option>
        <option value="14">Sk√•ne</option>
        <option value="15">Sm√•land</option>
        <option value="16">Stockholm</option>
        <option value="17">S√∂dermanland</option>
        <option value="18">Uppland</option>
        <option value="19">V√§rmland</option>
        <option value="20">V√§sterbotten</option>
        <option value="21">V√§sterg√∂tland</option>
        <option value="22">V√§stmanland</option>
        <option value="23">√Öngermanland</option>
        <option value="13">√ñrebro L√§n</option>
        <option value="24">√ñsterg√∂tland</option>
      </select>
    </div>

    <div>
      <label class="block text-sm">Fr√•n:</label>
      <input id="dateFrom" type="date" class="border rounded px-2 py-1">
    </div>

    <div>
      <label class="block text-sm">Till:</label>
      <input id="dateTo" type="date" class="border rounded px-2 py-1">
    </div>

    <button onclick="loadInterval()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mt-5">
      Ladda
    </button>

  </div>
</div>

<!-- SELECTORS -->
<div class="bg-white shadow p-4 rounded mb-6 flex items-center gap-8 flex-wrap">
  <div>
    <label class="block font-semibold">Serie:</label>
    <select id="seriesSelect" onchange="renderSeriesStats()" class="border rounded px-2 py-1 w-64">
      <option value="">‚Äì v√§lj serie ‚Äì</option>
    </select>
  </div>

  <div>
    <label class="block font-semibold">Domare:</label>
    <select id="refSelect" onchange="renderRefereeStats()" class="border rounded px-2 py-1 w-64">
      <option value="">‚Äì v√§lj domare ‚Äì</option>
    </select>
  </div>
</div>

<!-- OUTPUT -->
<div id="rankingOutput" class="mb-6"></div>
<div id="seriesOutput" class="mb-6"></div>
<div id="refOutput"></div>



<script>
// ===============================================
// GLOBAL STATE
// ===============================================
let allMatches = [];
let allSeries = new Set();
let allRefs = new Set();


// ===============================================
// HELPERS
// ===============================================
function sleep(ms) {
  return new Promise(res => setTimeout(res, ms));
}

function mapRole(desc) {
  if (!desc) return "Other";
  let d = desc.toLowerCase().trim();

  if (d.includes("f√∂rstedomare")) return "D1";
  if (d.includes("andredomare")) return "D2";
  if (d.includes("tredjedomare")) return "D3";
  if (d.includes("fj√§rdedomare")) return "D4";

  if (d.includes("ass. domare 1") || d.includes("ass.domare 1")) return "AD1";
  if (d.includes("ass. domare 2") || d.includes("ass.domare 2")) return "AD2";

  if (d === "domare") return "HD";

  return "Other";
}


// ===============================================
// FETCH WITH RETRY (Pro version)
// Retry: 3 g√•nger ¬∑ 250ms paus ¬∑ API-validering
// ===============================================
async function fetchDay(date) {
  const district = document.getElementById("districtSelect").value;

  const endpoint =
    `https://www.gbgfotboll.se/api/matches-today/games/?showReferees=true&associationId=${district}&date=${date}`;

  const url = "https://corsproxy.io/?" + encodeURIComponent(endpoint);

  for (let attempt = 1; attempt <= 3; attempt++) {
    try {
      const res = await fetch(url, { cache: "no-cache" });

      if (!res.ok) {
        console.warn(`‚ùó API gav status ${res.status} (${date})`);
        await sleep(150);
        continue;
      }

      const data = await res.json();

      // Validera att strukturen √§r korrekt
      if (!data || !Array.isArray(data.competitions)) {
        console.warn(`‚ö† Tomt/trasigt svar (${date})`, data);
        await sleep(150);
        continue;
      }

      return data;

    } catch (err) {
      console.warn(`‚ö† Fetch dag ${date} misslyckades (f√∂rs√∂k ${attempt})`);
      await sleep(250);
    }
  }

  console.error(`‚õî Kunde inte h√§mta dag: ${date}`);
  return null;
}


// ===============================================
// LOAD FULL INTERVAL (Pro version)
// Stabil, konsekvent och robust
// ===============================================
async function loadInterval() {
  const from = document.getElementById("dateFrom").value;
  const to = document.getElementById("dateTo").value;

  if (!from || !to) return alert("V√§lj datumintervall!");

  // reset
  allMatches = [];
  allSeries.clear();
  allRefs.clear();

  const loading = document.getElementById("loadingBar");
  const progress = document.getElementById("loadingProgress");
  const text = document.getElementById("loadingText");

  loading.classList.remove("hidden");
  progress.style.width = "0%";

  let current = new Date(from);
  const end = new Date(to);

  const totalDays =
    Math.floor((end - current) / 86400000) + 1;

  let completedDays = 0;

  while (current <= end) {
    const d = current.toISOString().slice(0, 10);
    text.textContent = `H√§mtar ${d}‚Ä¶`;

    const data = await fetchDay(d);

    completedDays++;
    progress.style.width = ((completedDays / totalDays) * 100) + "%";

    if (data) {
      for (const comp of data.competitions) {
        allSeries.add(comp.name);

        for (const g of comp.games) {
          const fullDate = g.date;

          allMatches.push({
            serie: comp.name,
            date: fullDate.slice(0, 10),
            time: fullDate.slice(11, 16),
            hall: g.location,
            home: g.homeTeam.name,
            away: g.awayTeam.name,
            referees: g.referees
          });

          for (const r of g.referees)
            allRefs.add(r.name);
        }
      }
    }

    await sleep(250); // stabilare API
    current.setDate(current.getDate() + 1);
  }

  loading.classList.add("hidden");

  populateDropdowns();
  renderRanking();
}



// ===============================================
// DROPDOWNS
// ===============================================
function populateDropdowns() {
  const s = document.getElementById("seriesSelect");
  const r = document.getElementById("refSelect");

  s.innerHTML = '<option value="">‚Äì v√§lj serie ‚Äì</option>';
  r.innerHTML = '<option value="">‚Äì v√§lj domare ‚Äì</option>';

  [...allSeries].sort().forEach(serie =>
    s.innerHTML += `<option>${serie}</option>`
  );

  [...allRefs].sort().forEach(ref =>
    r.innerHTML += `<option>${ref}</option>`
  );
}



// ===============================================
// RANKING TABLE
// ===============================================
function renderRanking() {
  const box = document.getElementById("rankingOutput");
  box.innerHTML = "";

  if (!allMatches.length) return;

  let stats = {};

  for (const m of allMatches) {
    const isFutsal = m.serie.toLowerCase().includes("futsal");

    for (const r of m.referees) {
      const role = mapRole(r.roleDescription);

      if (!stats[r.name]) {
        stats[r.name] = {
          total: 0,
          HD: 0, AD1: 0, AD2: 0, D4: 0,
          D1: 0, D2: 0, D3: 0
        };
      }

      stats[r.name].total++;

      if (!isFutsal && ["HD","AD1","AD2","D4"].includes(role))
        stats[r.name][role]++;

      if (isFutsal && ["D1","D2","D3"].includes(role))
        stats[r.name][role]++;
    }
  }

  const ranking = Object.entries(stats)
    .sort((a,b) => b[1].total - a[1].total);

  let html = `
    <div class="bg-white shadow p-4 rounded">
      <h2 class="text-xl font-bold mb-4">üèÜ Mest aktiva domare</h2>
      <div class="max-h-[500px] overflow-y-scroll border rounded">

      <table class="w-full text-sm border-collapse">

        <tr class="bg-gray-100 font-semibold">
          <th class="p-2"></th>
          <th class="p-2"></th>
          <th class="p-2"></th>
          <th class="p-2 text-center bg-lime-200" colspan="4">Fotboll</th>
          <th class="p-2 text-center bg-cyan-200" colspan="3">Futsal</th>
        </tr>

        <tr class="bg-gray-200 font-semibold">
          <th class="p-2 text-left">#</th>
          <th class="p-2 text-left">Domare</th>
          <th class="p-2 text-left">Totalt</th>
          <th class="p-2 bg-lime-300">HD</th>
          <th class="p-2 bg-lime-300">AD1</th>
          <th class="p-2 bg-lime-300">AD2</th>
          <th class="p-2 bg-lime-300">D4</th>
          <th class="p-2 bg-cyan-300">D1</th>
          <th class="p-2 bg-cyan-300">D2</th>
          <th class="p-2 bg-cyan-300">D3</th>
        </tr>
  `;

  let i = 1;
  for (const [name, s] of ranking) {
    html += `
      <tr class="border-b">
        <td class="p-2">${i++}</td>
        <td class="p-2">${name}</td>
        <td class="p-2 font-bold">${s.total}</td>
        <td class="p-2 bg-lime-100">${s.HD}</td>
        <td class="p-2 bg-lime-100">${s.AD1}</td>
        <td class="p-2 bg-lime-100">${s.AD2}</td>
        <td class="p-2 bg-lime-100">${s.D4}</td>
        <td class="p-2 bg-cyan-100">${s.D1}</td>
        <td class="p-2 bg-cyan-100">${s.D2}</td>
        <td class="p-2 bg-cyan-100">${s.D3}</td>
      </tr>
    `;
  }

  html += `</table></div></div>`;
  box.innerHTML = html;
}



// ===============================================
// SERIES STATS
// ===============================================
function renderSeriesStats() {
  const serie = document.getElementById("seriesSelect").value;
  const box = document.getElementById("seriesOutput");

  box.innerHTML = "";
  if (!serie) return;

  const matches = allMatches.filter(m => m.serie === serie);
  let stats = {};

  for (const m of matches) {
    for (const r of m.referees) {
      const role = mapRole(r.roleDescription);
      if (!stats[r.name])
        stats[r.name] = {HD:0,AD1:0,AD2:0,D4:0,D1:0,D2:0,D3:0,total:0};
      stats[r.name][role]++;
      stats[r.name].total++;
    }
  }

  let html = `
    <div class="bg-white shadow p-4 rounded">
      <h2 class="text-xl font-bold mb-4">üìä Statistik ‚Äì ${serie}</h2>
      <table class="w-full text-sm">
        <tr class="bg-gray-200 font-semibold">
          <th class="p-2">Domare</th>
          <th class="p-2">HD</th>
          <th class="p-2">AD1</th>
          <th class="p-2">AD2</th>
          <th class="p-2">D4</th>
          <th class="p-2">D1</th>
          <th class="p-2">D2</th>
          <th class="p-2">D3</th>
          <th class="p-2">Totalt</th>
        </tr>
  `;

  for (const [name, s] of Object.entries(stats)) {
    html += `
      <tr class="border-b">
        <td class="p-2">${name}</td>
        <td class="p-2">${s.HD}</td>
        <td class="p-2">${s.AD1}</td>
        <td class="p-2">${s.AD2}</td>
        <td class="p-2">${s.D4}</td>
        <td class="p-2">${s.D1}</td>
        <td class="p-2">${s.D2}</td>
        <td class="p-2">${s.D3}</td>
        <td class="p-2 font-bold">${s.total}</td>
      </tr>`;
  }

  html += "</table></div>";
  box.innerHTML = html;
}



// ===============================================
// REFEREE VIEW
// ===============================================
function renderRefereeStats() {
  const name = document.getElementById("refSelect").value;
  const box = document.getElementById("refOutput");

  box.innerHTML = "";
  if (!name) return;

  const matches = allMatches
    .filter(m => m.referees.some(r => r.name === name))
    .sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time));

  let s = {HD:0,AD1:0,AD2:0,D4:0,D1:0,D2:0,D3:0,total:0};
  let colleagues = {};

  for (const m of matches) {
    for (const r of m.referees) {
      const role = mapRole(r.roleDescription);

      if (r.name === name) {
        s[role]++; 
        s.total++;
      } else {
        colleagues[r.name] = (colleagues[r.name] || 0) + 1;
      }
    }
  }

  let html = `
    <div class="bg-white shadow p-4 rounded">

      <h2 class="text-2xl font-bold mb-4">${name}</h2>

      <p class="mb-4 text-sm">
        HD: ${s.HD} &nbsp;
        AD1: ${s.AD1} &nbsp;
        AD2: ${s.AD2} &nbsp;
        D4: ${s.D4} &nbsp;
        D1: ${s.D1} &nbsp;
        D2: ${s.D2} &nbsp;
        D3: ${s.D3} &nbsp;
        <b>Totalt: ${s.total}</b>
      </p>

      <h3 class="text-xl font-bold mt-4 mb-2">üìÖ Matcher</h3>
  `;

  for (const m of matches) {
    const line = m.referees
      .map(r => {
        const role = mapRole(r.roleDescription);
        return r.name === name
          ? `<b>${r.name} (${role})</b>`
          : `${r.name} (${role})`;
      }).join(", ");

    html += `
      <div class="border-b py-3 text-sm leading-tight">
        <div>${m.date} ${m.time}, ${m.hall}</div>
        <div>${m.serie}, ${m.home} ‚Äì ${m.away}</div>
        <div>${line}</div>
      </div>
    `;
  }

  html += `
      <h3 class="text-xl font-bold mt-6 mb-2">üë• Domarkollegor</h3>
      <table class="w-full text-sm">
        <tr class="bg-gray-200 font-semibold">
          <th class="p-2 text-left">Kollega</th>
          <th class="p-2 text-left">Matcher ihop</th>
        </tr>
  `;

  for (const [col, count] of Object.entries(colleagues)) {
    html += `<tr><td class="p-2">${col}</td><td class="p-2">${count}</td></tr>`;
  }

  html += "</table></div>";
  box.innerHTML = html;
}

</script>

</body>
</html>
